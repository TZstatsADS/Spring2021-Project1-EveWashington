---
title: "Party Perception's Role in Elections"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. 

#Perception in elections 

[intro about what roles perception of qualities play in elections]

##Set Up

Install Packages and load the raw data

```{r load libraries, warning=FALSE, message=FALSE, include=FALSE}
packages.used=as.list(
  c(
  "tidyverse",
  "haven",
  "devtools",
  "RColorBrewer",
  "data.table",
  "ggplot2",
  "dplyr",
  "gdata")
)

check.pkg = function(x){
  if(!require(x, character.only=T)) install.packages(x, 
                                                     character.only=T,
                                                     dependence=T)
}

lapply(packages.used, check.pkg)

library(haven)
anes_dat <-
    read_sav("../data/anes_timeseries_cdf.sav")
```

Create two output data files, one for the perceptions of the democratic candidate, another for the perceptions of the republican candidate. Both these datasets will also include the vote decision, to see how connected perceptions are to voter turnouts

```{r labelled variables subset}
Election_years=as.character(seq(1952, 2016, 4))

anes_dem=anes_dat%>%
  mutate(
    year=as_factor(VCF0004),
    vote=as_factor(VCF0706),
    Intelligent	=	as_factor(	VCF0350	),
    Compassionate	=	as_factor(	VCF0351	),
    Decent	=	as_factor(	VCF0352	),
    Inspiring	=	as_factor(	VCF0353	),
    Knowledgeable	=	as_factor(	VCF0354	),
    Moral	=	as_factor(	VCF0355	),
    Leadership	=	as_factor(	VCF0356	),
    Cares	=	as_factor(	VCF0357	)
  )%>%
  filter(year %in% Election_years)

anes_dem = anes_dem%>%
  select(year, vote, Intelligent,	Compassionate,	Decent,	Inspiring,	Knowledgeable,	Moral,	Leadership,	Cares)%>%
  gather(key = "quality", value = "measure", -year, -vote, na.rm = TRUE,
  convert = FALSE, factor_key = FALSE)

save(anes_dem, file="../output/data_dem.RData")


anes_rep=anes_dat%>%
  mutate(
    year=as_factor(VCF0004),
    vote=as_factor(VCF0706),
    Intelligent	=	as_factor(	VCF0362	),
    Compassionate	=	as_factor(	VCF0363	),
    Decent	=	as_factor(	VCF0364	),
    Inspiring	=	as_factor(	VCF0365	),
    Knowledgeable	=	as_factor(	VCF0366	),
    Moral	=	as_factor(	VCF0367	),
    Leadership	=	as_factor(	VCF0368	),
    Cares	=	as_factor(	VCF0369	)
  )%>%
  filter(year %in% Election_years)


anes_rep = anes_rep %>% 
  select(year, vote, Intelligent,	Compassionate,	Decent,	Inspiring,	Knowledgeable,	Moral,	Leadership,	Cares) %>%
  gather(key = "quality", value = "measure", -year, -vote, na.rm = TRUE,
  convert = FALSE, factor_key = FALSE)

save(anes_rep, file="../output/data_rep.RData")

anes_all <- gdata::combine(anes_dem, anes_rep)

save(anes_all, file="../output/data_all.RData")

```

For initial analysis lets make some bar charts, later we will facet them to look at the data diffrently. 

```{r}


p<- ggplot(anes_all, mapping = aes(fill=source, x=measure, group=interaction(source, quality), y= (..prop..))) + 
  geom_bar(position="dodge") +
  scale_fill_manual(values = c("#054C70","#b5040a")) +
  geom_text(aes(label=scales::percent(round(..prop..,2)), 
                y=..prop..), stat="count", vjust=-.5, position=position_dodge(.9)) +
  scale_y_continuous(limits=c(0,1),labels = scales::percent) 
  
```


##What qualities describe do voters use to describe Democrats and Republicans?
```{r}
p + facet_wrap(~quality)

```

```{r}
seq(41, 64, 8)
```

##How has voters decisons around a party's canidates change over time?
```{r}
p + facet_grid(quality ~ year)
time <- p + facet_grid(quality ~ year)

```

```{r}
time_data <- layer_data(time, 1)

#filter out years without data
time_data <- filter(time_data, (xmax < 2.5 & as.integer(PANEL) > 40) )
```

```{r}
#add year
time_data$year <- as.integer(time_data$PANEL)
for (x in seq(0,7)){
  time_data$year[as.integer(time_data$PANEL)==seq(41+x, 64, 8)] <- (1980 + 4*x)
}


time_data$quality <- time_data$PANEL
time_data$quality[as.integer(time_data$PANEL)==seq(41, 48)] <- "Knowledgeable"
time_data$quality[as.integer(time_data$PANEL)==seq(49, 56 )] <- "Leadership"
time_data$quality[as.integer(time_data$PANEL)==seq(57, 64 )] <- "Moral"

```

##What is the relationship between perception and votes?
```{r}
p + facet_grid(quality ~ vote)

```

